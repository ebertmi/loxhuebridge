name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v2.1.0

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release directory
        run: |
          mkdir -p release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}

      - name: Copy files to release directory
        run: |
          cp -r src release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp -r public release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp package.json release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp package-lock.json release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp ecosystem.config.js release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp README.md release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp QUICKSTART.md release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp CHANGELOG.md release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/
          cp LICENSE release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}/

      - name: Create tar.gz archive
        run: |
          cd release
          tar -czf loxhuebridge-${{ steps.get_version.outputs.VERSION }}.tar.gz loxhuebridge-${{ steps.get_version.outputs.VERSION }}

      - name: Create zip archive
        run: |
          cd release
          zip -r loxhuebridge-${{ steps.get_version.outputs.VERSION }}.zip loxhuebridge-${{ steps.get_version.outputs.VERSION }}

      - name: Generate release notes
        id: release_notes
        run: |
          # Extract release notes from CHANGELOG.md if available
          if grep -q "## \[${{ steps.get_version.outputs.VERSION }}\]" CHANGELOG.md 2>/dev/null; then
            echo "NOTES<<EOF" >> $GITHUB_OUTPUT
            awk '/## \[${{ steps.get_version.outputs.VERSION }}\]/,/## \[/' CHANGELOG.md | sed '$d' >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "NOTES=Release v${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.NOTES }}
          draft: false
          prerelease: false
          files: |
            release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}.tar.gz
            release/loxhuebridge-${{ steps.get_version.outputs.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

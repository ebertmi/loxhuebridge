<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>loxHueBridge</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Fira+Code:wght@400&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media',
            theme: {
                extend: {
                    colors: {
                        // Custom colors from CSS variables
                        'accent': '#85c440',
                        'sensor': '#ff9500',
                        'button-color': '#007aff',
                        'danger': '#ff3b30',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'mono': ['Fira Code', 'monospace'],
                    },
                }
            }
        }
    </script>

    <style>
        :root { --bg: #f4f6f8; --card-bg: #ffffff; --text-main: #1c1c1e; --text-muted: #636366; --border: #e1e4e8; --accent: #85c440; --sensor: #ff9500; --button: #007aff; --danger: #ff3b30; --radius: 12px; --input-bg: #ffffff; --modal-overlay: rgba(0,0,0,0.5); }
        @media (prefers-color-scheme: dark) { :root { --bg: #000000; --card-bg: #1c1c1e; --text-main: #f2f2f7; --text-muted: #aeaeb2; --border: #38383a; --input-bg: #2c2c2e; --modal-overlay: rgba(0,0,0,0.8); } }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { font-weight: 800; color: var(--accent); margin-bottom: 5px; }
        
        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; overflow-x: auto; }
        .tab { padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
        .tab.active { background: var(--text-main); color: var(--bg); }
        .tab[data-tab="light"].active { background: var(--accent); } .tab[data-tab="sensor"].active { background: var(--sensor); } .tab[data-tab="button"].active { background: var(--button); } .tab[data-tab="scene"].active { background: #9b59b6; } .tab[data-tab="system"].active, .tab[data-tab="diag"].active { background: #666; }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 30px; }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .chip { display: inline-flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border); padding: 6px 12px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; }
        .chip:hover { transform: translateY(-1px); }
        .chip.command { border-color: var(--accent); color: var(--accent); } 
        
        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
        
        /* INPUTS */
        input:not([type="checkbox"]), select { width: 100%; background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); padding: 12px; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        input[type="checkbox"] { width: auto; margin: 0 10px 0 0; transform: scale(1.3); accent-color: var(--accent); }
        input[type="range"] { padding: 0; }

        button.primary-btn { width: 100%; background: var(--text-main); color: var(--bg); font-weight: 700; border: 2px solid var(--text-main); padding: 5px; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        button.primary-btn:hover { opacity: 0.85; }
        button.primary-btn.btn-accent { background: var(--accent); border-color: var(--accent); }
        button.primary-btn.btn-gray { background: #666; border-color: #666; }
        button.secondary-btn { background: transparent; border: 2px solid var(--text-main); color: var(--text-main); font-weight: 700; padding: 5px; border-radius: 8px; cursor: pointer; }
        button.secondary-btn:hover { background: var(--text-main); color: var(--bg); }

        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .action-btn { background: transparent; border: 1px solid var(--border); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: var(--text-muted); }
        .action-btn:hover { border-color: var(--text-main); color: var(--text-main); }

        .mapping-list { display: flex; flex-direction: column; gap: 10px; }
        .mapping-item { display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border); border-left: 4px solid transparent; }
        .type-light, .type-group { border-left-color: var(--accent); } .type-sensor { border-left-color: var(--sensor); } .type-button { border-left-color: var(--button); }
        
        .mapping-lox { font-family: monospace; font-weight: 700; }
        .mapping-hue { font-size: 0.9rem; color: var(--text-muted); }
        .status-badges { display: flex; gap: 5px; margin-right: 10px; align-items: center; }
        .badge { font-size: 0.85rem; padding: 4px 8px; border-radius: 4px; background: var(--border); color: var(--text-muted); min-width: 20px; text-align: center; line-height: 1; }
        .del-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 4px 10px; border-radius: 6px; cursor: pointer; line-height: 1; }
        .info-btn { background: transparent; border: none; padding: 0 10px; font-size: 1.2em; cursor: pointer; opacity: 0.6; }
        .info-btn:hover { opacity: 1; }
        /* COLOR DOT */
        .color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,0.2); margin-left: 5px; vertical-align: middle; }
        /* SYNC CHECKBOX */
        .sync-check { cursor: pointer; margin-right: 10px; margin-bottom: 0; display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: var(--text-muted); background: var(--input-bg); padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); line-height: 1; }
        .sync-check:hover { border-color: var(--accent); color: var(--text-main); }
        .sync-check input { margin: 0; transform: scale(1.2); width: auto; }
        .sync-active { border-color: var(--accent); background: rgba(133, 196, 64, 0.1); color: var(--accent); font-weight: bold; }

        .log-console { background-color: #1a1a1a; color: #f0f0f0; font-family: 'Fira Code', monospace; padding: 15px; border-radius: 8px; height: 300px; overflow-y: auto; font-size: 0.85rem; line-height: 1.4; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; white-space: pre-wrap; word-break: break-word; }
        .log-time { color: #888; margin-right: 10px; }
        .log-level { font-weight: bold; margin-right: 10px; }
        .log-cat { display:inline-block; padding:1px 4px; border-radius:3px; font-size:0.75rem; margin-right:10px; color:#000; font-weight:bold; }
        .cat-LIGHT { background:#85c440; } .cat-SENSOR { background:#ff9500; } .cat-BUTTON { background:#007aff; } .cat-SYSTEM { background:#999; } .cat-HUE { background:#9b59b6; } .cat-UDP { background:#3498db; }
        .level-INFO { color: #61afef; } .level-SUCCESS { color: #98c379; } .level-WARN { color: #e5c07b; } .level-ERROR { color: #e06c75; } .level-DEBUG { color: #c678dd; }
        
        /* Filter Buttons */
        .filter-bar { display: flex; gap: 8px; margin-bottom: 10px; }
        .filter-btn { background: transparent; border: 1px solid var(--border); color: var(--text-muted); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--text-main); color: var(--bg); font-weight: bold; border-color: var(--text-main); }

        .settings-table { width: 100%; border-collapse: collapse; }
        .settings-table td { padding: 8px; border-bottom: 1px solid var(--border); }
        .settings-table td:first-child { font-weight: bold; color: var(--text-muted); width: 40%; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(18px); }
        .tab-content { display: none; } .tab-content.active { display: block; }

        /* --- MODAL STYLES --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--card-bg); padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 80vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-list { overflow-y: auto; flex: 1; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 20px; }
        /* Modal Item Fix */
        .modal-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); justify-content: flex-start; text-align: left; }
        .modal-item:last-child { border-bottom: none; }
        .modal-item div { flex: 1; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-sec { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-prim { background: var(--text-main); color: var(--bg); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-link { background: none; border: none; color: var(--accent); cursor: pointer; font-weight: bold; padding: 0; }
    
        /* DETAILS TABLE */
        .details-table { width: 100%; border-collapse: collapse; }
        .details-table td { padding: 8px 0; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .details-table td:first-child { font-weight: bold; color: var(--text-muted); width: 40%; }

        /* DIAGNOSE */
        .status-ok { color: #4caf50; font-weight: bold; }
        .status-err { color: #f44336; font-weight: bold; }
        .mac-addr { font-family: monospace; color: #888; font-size: 0.8em; }
        .diag-h3 { margin: 20px 0 10px 0; font-size: 1rem; color: var(--text-main); border-bottom: 2px solid var(--border); padding-bottom: 5px; }


        /* === COMPONENT UTILITIES === */

        /* Button utilities */
        .btn-compact {
            width: auto;
            padding: 6px 12px !important;
            font-size: 0.85rem;
            margin: 0 !important;
            line-height: 1.5;
        }

        .btn-small {
            width: auto !important;
            margin: 0 !important;
            margin-top: 0 !important;
            line-height: 1.5;
            font-size: inherit;
        }

        /* Info/Hint text */
        .hint-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .hint-accent {
            font-size: 0.8rem;
            color: var(--accent);
            margin-top: 5px;
            margin-bottom: 15px;
        }

        /* Divider */
        .divider {
            text-align: center;
            margin: 15px 0;
        }

        /* Help section / Collapsible */
        .help-section {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .help-summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--accent);
        }

        .help-content {
            margin-top: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Scene/content meta text */
        .scene-meta {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .scene-uuid {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>

<div class="container">
    <header><h1>loxHueBridge</h1><p style="color:var(--text-muted)">Dashboard</p></header>
    
    <div class="tabs">
        <div class="tab active" data-tab="light" onclick="setTab('light')">üí° Lichter</div>
        <div class="tab" data-tab="sensor" onclick="setTab('sensor')">üì° Sensoren</div>
        <div class="tab" data-tab="button" onclick="setTab('button')">üîò Schalter</div>
        <div class="tab" data-tab="scene" onclick="setTab('scene')">üé¨ Szenen</div>
        <div class="tab" data-tab="system" onclick="setTab('system')">‚öôÔ∏è System</div>
        <div class="tab" data-tab="diag" onclick="setTab('diag')">ü©∫ Diagnose</div>
    </div>

    <div id="main-interface" class="tab-content active">
        <div class="detected-area" id="detectedContainer" style="display:none">
            <div class="card" style="border: 1px dashed var(--border);">
                <h3 style="margin-top:0; font-size: 1rem;">‚ö° Neue Loxone Befehle</h3>
                <div id="detectedList" class="chip-container"></div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin: 5px 0 0 0;">Klicke auf einen Befehl, um ihn zuzuordnen.</p>
            </div>
        </div>
        <div class="grid">
            <div>
                <h2>Verbindung</h2>
                <div class="card">
                    <label>Loxone Name</label><input type="text" id="inName" placeholder="...">
                    <p id="hintAll" style="font-size: 0.8rem; color: var(--accent); margin-top: 5px; margin-bottom: 15px; display:none">
                        ‚ÑπÔ∏è Tipp: Nutze <b>'all'</b> im Dropdown oder als Namen, um alle zu steuern.
                    </p>
                    <div style="text-align: center; margin: 15px 0;">‚¨á</div>
                    <label>Hue Ger√§t</label><select id="hueTarget"><option>Lade...</option></select>
                    <button class="primary-btn" onclick="addMapping()">Speichern</button>
                </div>
            </div>
            <div>
                <div class="header-actions">
                    <h2 class="m-0">Aktiv</h2>
                    <button class="secondary-btn m-0" onclick="openExportModal()">üì• XML Exportieren</button>
                </div>
                <div id="mappingList" class="mapping-list"></div>
            </div>
        </div>
    </div>

    <div id="system-interface" class="tab-content">
        <h2>Aktuelle Konfiguration</h2>
        <div class="card">
            <table class="settings-table" id="settingsTable"><tr><td>Lade...</td><td></td></tr></table>
            <div style="text-align: right; margin-top: 15px;">
                <button class="primary-btn" style="width:auto; margin:0;" onclick="saveSettings()">Speichern</button>
            </div>
        </div>
        <h2>Server Logs</h2>
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="ALL" onclick="setLogFilter('ALL')">Alle</button>
            <button class="filter-btn" data-filter="LIGHT" onclick="setLogFilter('LIGHT')">üí° Lichter</button>
            <button class="filter-btn" data-filter="SENSOR" onclick="setLogFilter('SENSOR')">üì° Sensoren</button>
            <button class="filter-btn" data-filter="BUTTON" onclick="setLogFilter('BUTTON')">üîò Schalter</button>
            <button class="filter-btn" data-filter="HUE" onclick="setLogFilter('HUE')">üåâ Hue Bridge</button>
            <button class="filter-btn" data-filter="UDP" onclick="setLogFilter('UDP')">üì§ UDP</button>
            <button class="filter-btn" data-filter="SYSTEM" onclick="setLogFilter('SYSTEM')">‚öôÔ∏è System</button>
        </div>
        <div class="log-console" id="logConsole"><div class="text-center text-gray" style="padding-top:20px">Warte auf Logs...</div></div>
    </div>

    <div id="diag-interface" class="tab-content">
        <h2>Zigbee Netzwerk Status</h2>
        <div class="card">
            <button class="primary-btn btn-small mt-0" onclick="loadDiagnostics()">üîÑ Aktualisieren</button>
            <div id="diagContent" class="mt-4">
                <div class="text-center text-muted-primary">Klicke auf Aktualisieren...</div>
            </div>
        </div>
    </div>

    <div id="scene-interface" class="tab-content">
        <h2>Hue Szenen</h2>
        <div class="card">
            <p class="scene-meta">
                Hier werden alle in der Hue Bridge gespeicherten Szenen angezeigt.
            </p>
            <div class="flex items-center gap-2.5 mb-4">
                <button class="primary-btn btn-small" onclick="loadScenes()">üîÑ Aktualisieren</button>
                <button class="secondary-btn btn-small" onclick="openSceneExportModal()">üì• XML Exportieren</button>
            </div>

            <details class="help-section">
                <summary class="help-summary">üí° Loxone Integration Hilfe</summary>
                <div class="help-content">
                    <p class="mt-0"><strong>Nach dem XML Export stehen dir zwei Optionen zur Verf√ºgung:</strong></p>

                    <div style="background:var(--card-bg); padding:12px; border-radius:6px; margin-bottom:12px; border-left:3px solid var(--accent)">
                        <strong>Option 1: Direkte Szenensteuerung</strong>
                        <ul class="mt-2 pl-5 mb-0">
                            <li>Jede Szene erh√§lt einen eigenen virtuellen Ausgang</li>
                            <li>Einfach, aber viele Ausg√§nge bei vielen Szenen</li>
                            <li>Ideal f√ºr feste Szenen-Buttons</li>
                        </ul>
                    </div>

                    <div style="background:var(--card-bg); padding:12px; border-radius:6px; border-left:3px solid #9b59b6">
                        <strong>Option 2: Status-Baustein + Generischer Ausgang (empfohlen)</strong>
                        <ul class="mt-2 pl-5 mb-0">
                            <li>Ein <strong>generischer Ausgang</strong> "Scene (Generic)" wird exportiert</li>
                            <li>Nutze den <strong>Status-Baustein</strong> in Loxone:
                                <ul class="mt-1">
                                    <li>Stimmung 1 ‚Üí Szenen-UUID (z.B. <code style="background:var(--input-bg); padding:2px 4px; border-radius:3px; font-size:0.85rem">abc-123...</code>)</li>
                                    <li>Stimmung 2 ‚Üí andere Szenen-UUID</li>
                                    <li>usw.</li>
                                </ul>
                            </li>
                            <li>Verbinde Status-Ausgang mit "Scene (Generic)"</li>
                            <li>‚úÖ Nur ein virtueller Ausgang f√ºr alle Szenen!</li>
                            <li>‚úÖ Szenen √§ndern ohne Loxone Config zu bearbeiten</li>
                        </ul>
                    </div>

                    <p style="margin-bottom:0; color:var(--text-muted); font-size:0.85rem">
                        <strong>Tipp:</strong> Die Szenen-UUIDs werden in grau neben dem Szenennamen angezeigt. Kopiere diese f√ºr den Status-Baustein.
                    </p>
                </div>
            </details>

            <div id="scenesList" class="mapping-list">
                <div class="text-center text-muted-primary">Klicke auf Aktualisieren...</div>
            </div>
        </div>
    </div>
</div>

<div id="exportModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="m-0">Export Auswahl</h2>
            <button class="btn-link" onclick="toggleSelectAll()">Alles markieren</button>
        </div>
        <div class="modal-list" id="exportList">
            </div>
        <div class="modal-actions">
            <button class="btn-sec" onclick="closeModal('exportModal')">Abbrechen</button>
            <button class="btn-prim" onclick="doExport()">Exportieren</button>
        </div>
    </div>
</div>

<div id="sceneExportModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="m-0">Szenen Export</h2>
            <button class="btn-link" onclick="toggleSelectAllScenes()">Alles markieren</button>
        </div>
        <div class="modal-list" id="sceneExportList"></div>
        <div class="modal-actions">
            <button class="btn-sec" onclick="closeModal('sceneExportModal')">Abbrechen</button>
            <button class="btn-prim" onclick="doSceneExport()">Exportieren</button>
        </div>
    </div>
</div>

<div id="detailsModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h2 class="m-0">Ger√§te Details</h2>
            <button class="btn-link" onclick="closeModal('detailsModal')">‚úï</button>
        </div>
        <div id="detailsContent"></div>
        <div class="modal-actions mt-4">
            <button class="btn-sec" onclick="closeModal('detailsModal')">Schlie√üen</button>
        </div>
    </div>
</div>

<script>
    let currentTab = 'light';
    let targets = [];
    let mappings = [];
    let status = {};
    let detectedHistory = [];
    let scenes = [];
    let activeScenes = new Set(); // Track which scenes are currently active
    let logInterval = null;
    let allSelected = false;
    let currentLogFilter = 'ALL';
    let cachedLogs = [];

    async function init() {
        await loadTargets();
        await loadMappings();
        loadDetected();
        loadStatus();
        setInterval(loadDetected, 3000);
        setInterval(loadStatus, 2000);
    }

    function setTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');

        // HINWEIS NUR BEI LIGHTS
        document.getElementById('hintAll').style.display = tab === 'light' ? 'block' : 'none';

        // Reset View States
        document.getElementById('main-interface').classList.remove('active');
        document.getElementById('system-interface').classList.remove('active');
        document.getElementById('diag-interface').classList.remove('active');
        document.getElementById('scene-interface').classList.remove('active');
        if(logInterval) { clearInterval(logInterval); logInterval = null; }

        if (tab === 'system') {
            document.getElementById('system-interface').classList.add('active');
            loadSettings();
            loadLogs();
            if(!logInterval) logInterval = setInterval(loadLogs, 2000);
        } else if (tab === 'diag') {
            document.getElementById('diag-interface').classList.add('active');
            loadDiagnostics();
        } else if (tab === 'scene') {
            document.getElementById('scene-interface').classList.add('active');
            loadScenes();
        } else {
            document.getElementById('main-interface').classList.add('active');
            const btn = document.querySelector('.primary-btn');
            const color = tab==='light' ? 'var(--accent)' : (tab==='sensor' ? 'var(--sensor)' : 'var(--button)');
            btn.style.backgroundColor = color;
            btn.style.borderColor = color;
            renderDropdown(); renderMappings();
        }
    }

    // --- LOGGING & FILTER ---
    function setLogFilter(filter) {
        currentLogFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(b => {
            b.classList.toggle('active', b.dataset.filter === filter);
        });
        renderLogs(); // Re-Render cache
    }

    async function loadLogs() {
        try {
            const res = await fetch('/api/logs');
            cachedLogs = await res.json();
            renderLogs();
        } catch(e) {}
    }

    function renderLogs() {
        const consoleDiv = document.getElementById('logConsole');
        let filtered = cachedLogs;
        if (currentLogFilter !== 'ALL') {
            filtered = cachedLogs.filter(l => l.cat === currentLogFilter);
        }
        
        if (filtered.length === 0) {
            consoleDiv.innerHTML = '<div class="text-center text-gray-light">Keine Logs in dieser Kategorie.</div>';
            return;
        }

        const html = filtered.map(l => {
            const cat = l.cat || 'SYSTEM';
            return `<div class="log-entry"><span class="log-time">${l.time}</span><span class="log-cat cat-${cat}">${cat}</span><span class="log-level level-${l.level}">${l.level}</span>${l.msg}</div>`
        }).join('');
        
        // Simple diff check to avoid flicker (if content is same length)
        if(consoleDiv.innerHTML.length !== html.length) consoleDiv.innerHTML = html;
    }

    // --- DIAGNOSTICS (OPTIMIZED) ---
    async function loadDiagnostics() {
        const container = document.getElementById('diagContent');
        container.innerHTML = '<div class="text-center">Lade Daten...</div>';
        try {
            const res = await fetch('/api/diagnostics');
            const data = await res.json();
            if(data.length === 0) { container.innerHTML = 'Keine Daten.'; return; }
            
            const lights = data.filter(d => d.type === 'Licht');
            const sensors = data.filter(d => d.type === 'Sensor');
            const buttons = data.filter(d => d.type === 'Taster');
            const others = data.filter(d => d.type === 'Sonstiges' || d.type === 'Unbekannt');
            
            let html = "";
            html += renderDiagSection("üí° Lichter", lights);
            html += renderDiagSection("üì° Sensoren", sensors);
            html += renderDiagSection("üîò Taster & Schalter", buttons);
            if(others.length > 0) html += renderDiagSection("‚ùì Sonstige", others);
            
            container.innerHTML = html;
        } catch(e) { container.innerHTML = `<div style="color:red">Fehler: ${e.message}</div>`; }
    }

    function renderDiagSection(title, items) {
        if(items.length === 0) return "";
        let html = `<div class="diag-h3">${title} (${items.length})</div>`;
        html += `<table class="settings-table"><thead><tr style="text-align:left; color:var(--text-muted)"><th>Ger√§t</th><th>MAC / Info</th><th>Status</th></tr></thead><tbody>`;
        
        items.forEach(d => {
            const isOk = d.status === 'connected';
            const statusIcon = isOk ? 'üü¢' : 'üî¥';
            const statusText = isOk ? 'Verbunden' : 'Problem';
            const statusClass = isOk ? 'status-ok' : 'status-err';
            let extraInfo = '';
            if(d.last_seen) { const date = new Date(d.last_seen); extraInfo += `<div style="font-size:0.7em; color:#888">Zuletzt: ${date.toLocaleTimeString()}</div>`; }
            let batInfo = '';
            if(d.battery !== undefined && d.battery !== null) { 
                const bIcon = d.battery <= 20 ? 'üö®' : 'üîã';
                batInfo = ` <span class="badge" style="font-size:0.7em">${bIcon} ${d.battery}%</span>`; 
            }
            html += `<tr><td><b>${d.name}</b>${batInfo}</td><td class="mac-addr">${d.mac}${extraInfo}</td><td class="${statusClass}">${statusIcon} ${statusText}</td></tr>`;
        });
        html += '</tbody></table>';
        return html;
    }

    // --- HELFER ---
    function updateTransLabel(val) { document.getElementById('transVal').innerText = val + ' ms'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function openExportModal() {
        const list = document.getElementById('exportList');
        list.innerHTML = '';
        const filtered = mappings.filter(m => {
            if (currentTab === 'light') return m.hue_type === 'light' || m.hue_type === 'group';
            if (currentTab === 'sensor') return m.hue_type === 'sensor';
            if (currentTab === 'button') return m.hue_type === 'button';
            return false;
        });
        if(filtered.length === 0) return alert("Nichts zum Exportieren.");
        filtered.sort((a,b) => a.loxone_name.localeCompare(b.loxone_name));
        filtered.forEach(m => {
            const prefix = currentTab === 'light' ? '/' : '';
            const item = document.createElement('div');
            item.className = 'modal-item';
            item.innerHTML = `<input type="checkbox" class="modal-checkbox" value="${m.loxone_name}"><div><div style="font-weight:bold">${prefix}${m.loxone_name}</div><div style="font-size:0.8rem; color:var(--text-muted)">${m.hue_name}</div></div>`;
            list.appendChild(item);
        });
        document.getElementById('exportModal').style.display = 'flex';
        allSelected = false;
    }

    function showDetails(uuid) {
        const target = targets.find(t => t.uuid === uuid);
        if(!target) return;
        let content = `<table class="details-table">`;
        content += `<tr><td>Name</td><td>${target.name}</td></tr>`;
        content += `<tr><td>UUID</td><td style="font-size:0.8em; font-family:monospace">${target.uuid}</td></tr>`;
        content += `<tr><td>Typ</td><td>${target.type}</td></tr>`;
        if(target.capabilities) {
            const c = target.capabilities;
            content += `<tr><td>Farbe (RGB)</td><td>${c.supportsColor ? '‚úÖ Ja' : '‚ùå Nein'}</td></tr>`;
            content += `<tr><td>Farbtemp (WW)</td><td>${c.supportsCt ? '‚úÖ Ja' : '‚ùå Nein'}</td></tr>`;
            if(c.supportsCt) {
                const minK = Math.round(1000000 / c.max);
                const maxK = Math.round(1000000 / c.min);
                content += `<tr><td>Bereich</td><td>${minK}K - ${maxK}K</td></tr>`;
            }
        }
        content += `</table>`;
        document.getElementById('detailsContent').innerHTML = content;
        document.getElementById('detailsModal').style.display = 'flex';
    }

    function toggleSelectAll() {
        allSelected = !allSelected;
        document.querySelectorAll('.modal-checkbox').forEach(cb => cb.checked = allSelected);
    }

    function doExport() {
        const checked = document.querySelectorAll('.modal-checkbox:checked');
        if(checked.length === 0) return alert("Bitte w√§hlen.");
        const names = Array.from(checked).map(cb => cb.value).join(',');
        const type = currentTab === 'light' ? 'outputs' : 'inputs';
        window.location.href = `/api/download/${type}?names=${names}`;
        closeModal('exportModal');
    }

    // --- NEU: TOGGLE SYNC ---
    async function toggleSync(loxName, isActive) {
        const entry = mappings.find(m => m.loxone_name === loxName);
        if (entry) {
            entry.sync_lox = isActive;
            await fetch('/api/mapping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(mappings) });
            renderMappings(); // Refresh
        }
    }

    // --- MAIN APP LOGIC ---
    async function loadTargets() {
        try {
            const res = await fetch('/api/targets');
            targets = await res.json();
            if(currentTab !== 'system' && currentTab !== 'diag') renderDropdown();
        } catch(e){}
    }

    function renderDropdown() {
        const select = document.getElementById('hueTarget');
        select.innerHTML = '<option value="">-- W√§hlen --</option>';
        const filtered = targets.filter(t => {
            if (currentTab === 'light') return t.type === 'light' || t.type === 'group';
            if (currentTab === 'sensor') return t.type === 'sensor';
            if (currentTab === 'button') return t.type === 'button';
            return false;
        });
        const finalTargets = filtered.filter(t => !mappings.some(m => m.hue_uuid === t.uuid));
        
        if (currentTab === 'light') {
            const allOpt = document.createElement('option');
            allOpt.value = 'pseudo-all';
            allOpt.dataset.type = 'group';
            allOpt.innerHTML = 'üåü ALLE LICHTER (Zentral)';
            select.appendChild(allOpt);
        }

        const grpGroup = document.createElement('optgroup'); grpGroup.label = "R√§ume & Zonen";
        const lightGroup = document.createElement('optgroup'); lightGroup.label = "Einzellichter";
        const sensorGroup = document.createElement('optgroup'); sensorGroup.label = "Sensoren";
        const btnGroup = document.createElement('optgroup'); btnGroup.label = "Taster";
        let hasItems = false;

        finalTargets.forEach(t => {
            hasItems = true;
            const opt = document.createElement('option');
            opt.value = t.uuid; opt.dataset.type = t.type; opt.innerHTML = t.name;
            if (t.type === 'group') grpGroup.appendChild(opt);
            else if (t.type === 'sensor') sensorGroup.appendChild(opt);
            else if (t.type === 'button') btnGroup.appendChild(opt);
            else lightGroup.appendChild(opt);
        });

        if(grpGroup.children.length > 0) select.appendChild(grpGroup);
        if(lightGroup.children.length > 0) select.appendChild(lightGroup);
        if(sensorGroup.children.length > 0) select.appendChild(sensorGroup);
        if(btnGroup.children.length > 0) select.appendChild(btnGroup);
        if(!hasItems && currentTab !== 'light') select.innerHTML = '<option value="">(Alle Ger√§te zugeordnet)</option>';
    }

    async function loadMappings() {
        try {
            const res = await fetch('/api/mapping');
            mappings = await res.json();
            if(currentTab !== 'system' && currentTab !== 'diag') { renderMappings(); renderDropdown(); }
        } catch(e){}
    }

    async function loadStatus() {
        try {
            const res = await fetch('/api/status');
            status = await res.json();
            if(currentTab !== 'system' && currentTab !== 'diag') renderMappings();
        } catch(e){}
    }

    function renderMappings() {
        const list = document.getElementById('mappingList');
        list.innerHTML = '';
        const filtered = mappings.filter(m => {
            if (currentTab === 'light') return m.hue_type === 'light' || m.hue_type === 'group';
            if (currentTab === 'sensor') return m.hue_type === 'sensor';
            if (currentTab === 'button') return m.hue_type === 'button';
            return false;
        });

        if (filtered.length === 0) { list.innerHTML = '<div class="empty-state">Leer</div>'; return; }
        filtered.sort((a,b) => a.loxone_name.localeCompare(b.loxone_name));
        
        filtered.forEach(m => {
            const st = status[m.loxone_name] || {};
            let badges = '';
            
            if (st.motion !== undefined) { const icon = st.motion ? 'üèÉ' : 'üßò'; const bg = 'var(--border)'; badges += `<span class="badge" style="background:${bg}; font-size: 1.2em;">${icon}</span>`; }
            if (st.temp !== undefined) badges += `<span class="badge">${st.temp}¬∞C</span>`;
            if (st.lux !== undefined) badges += `<span class="badge">${st.lux} lx</span>`;
            if (st.bat !== undefined) { let icon = 'üîã'; let bg = 'var(--border)'; if (st.bat <= 20) { icon = 'üö®'; bg = '#ffcdcd'; } badges += `<span class="badge" style="background:${bg}">${icon} ${st.bat}%</span>`; }
            
            if (st.on !== undefined && st.on !== null) {
                 if(st.on || currentTab === 'light') {
                    const bg = st.on ? '#e1ffe1' : 'var(--border)';
                    badges += `<span class="badge" style="background:${bg}">${st.on ? 'AN' : 'AUS'}</span>`;
                 }
            }
            
            if (st.on) {
                if (st.bri !== undefined) badges += `<span class="badge">${Math.round(st.bri)}%</span>`;
                if (st.hex) badges += `<span class="color-dot" style="background-color:${st.hex}"></span>`;
            }
            if (st.rotary !== undefined) { const val = st.rotary > 0 ? `+${st.rotary}` : st.rotary; badges += `<span class="badge" style="background:#e1f5fe">üîÑ ${val}</span>`; }

            let infoBtn = '';
            if(m.hue_type === 'light') infoBtn = `<button class="info-btn" onclick="showDetails('${m.hue_uuid}')">‚ÑπÔ∏è</button>`;

            // NEU: SYNC CHECKBOX
            let syncControl = '';
            if (currentTab === 'light') {
                const isChecked = m.sync_lox === true ? 'checked' : '';
                const activeClass = m.sync_lox === true ? 'sync-active' : '';
                syncControl = `<label class="sync-check ${activeClass}" title="Status aktiv an Loxone senden"><input type="checkbox" ${isChecked} onchange="toggleSync('${m.loxone_name}', this.checked)">Sync</label>`;
            }

            const div = document.createElement('div');
            div.className = `mapping-item type-${m.hue_type}`;
            div.innerHTML = `
                <div><div class="mapping-lox">${m.loxone_name}</div><div class="mapping-hue">${m.hue_name} ${infoBtn}</div></div>
                <div style="display:flex; align-items:center;">${syncControl}<div class="status-badges">${badges}</div><button class="del-btn" onclick="deleteMapping('${m.loxone_name}')">‚úñ</button></div>
            `;
            list.appendChild(div);
        });
    }

    async function loadDetected() {
        try {
            const res = await fetch('/api/detected');
            const detected = await res.json();
            const filteredDetected = detected.filter(d => d.type === 'command');
            if (JSON.stringify(filteredDetected) === JSON.stringify(detectedHistory)) return;
            detectedHistory = filteredDetected;

            const list = document.getElementById('detectedList');
            const container = document.getElementById('detectedContainer');
            if (filteredDetected.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            list.innerHTML = '';
            
            filteredDetected.forEach(d => {
                const div = document.createElement('div');
                div.className = `chip command`;
                div.innerHTML = `<span>üì•</span> /${d.name}`;
                div.onclick = () => {
                    if (currentTab !== 'light') setTab('light');
                    document.getElementById('inName').value = d.name;
                    document.getElementById('inName').focus();
                };
                list.appendChild(div);
            });
        } catch(e){}
    }

    async function addMapping() {
        const name = document.getElementById('inName').value.trim().toLowerCase();
        const hueSelect = document.getElementById('hueTarget');
        if (!name || !hueSelect.value) return alert("Daten fehlen");
        mappings = mappings.filter(m => m.loxone_name.toLowerCase() !== name);
        let rawHueName = hueSelect.options[hueSelect.selectedIndex].text;
        let cleanHueName = rawHueName.replace(/^[üí°üè†üì°üîòüåü]\s?/, '');
        mappings.push({ loxone_name: name, hue_uuid: hueSelect.value, hue_name: cleanHueName, hue_type: hueSelect.options[hueSelect.selectedIndex].dataset.type });
        await fetch('/api/mapping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(mappings) });
        document.getElementById('inName').value = '';
        loadMappings(); loadDetected();
    }

    async function deleteMapping(name) {
        if(!confirm('L√∂schen?')) return;
        mappings = mappings.filter(m => m.loxone_name !== name);
        await fetch('/api/mapping', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(mappings) });
        renderMappings(); renderDropdown();
    }

    async function saveSettings() {
        const loxIp = document.getElementById('sys_loxIp').value;
        const loxPort = document.getElementById('sys_loxPort').value;
        const trans = document.getElementById('sys_trans').value;
        const debug = document.getElementById('sys_debug').checked;
        if(!loxIp) return alert("Loxone IP erforderlich");
        try {
            await fetch('/api/setup/loxone', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ loxoneIp: loxIp, loxonePort: loxPort, debug: debug, transitionTime: trans }) });
            alert("Gespeichert!");
            loadSettings();
        } catch(e) { alert("Fehler beim Speichern"); }
    }

	async function loadSettings() {
	        try {
	            console.log("Lade Einstellungen...");
	            const res = await fetch('/api/settings');
	            const s = await res.json();
	            console.log("Daten empfangen:", s);

	            const table = document.getElementById('settingsTable');
            
	            // Toggle Switch HTML
	            const toggleHtml = `<label class="switch"><input type="checkbox" id="sys_debug" ${s.debug ? 'checked' : ''}><span class="slider"></span></label>`;
            
	            // Transition Time Logic
	            const tTime = (s.transitionTime !== undefined && s.transitionTime !== null) ? s.transitionTime : 400;
	            const rangeHtml = `
	                <div style="display:flex; align-items:center">
	                    <input type="range" id="sys_trans" min="0" max="500" step="50" value="${tTime}" oninput="updateTransLabel(this.value)">
	                    <span id="transVal" style="margin-left:10px">${tTime} ms</span>
	                </div>`;

	            // Version Fallback
	            const ver = s.version || 'Unbekannt';

	            // HTML Zusammenbau (Lesbar, um Fehler zu vermeiden)
	            table.innerHTML = `
	                <tr>
	                    <td>Version</td>
	                    <td><span class="badge" style="background:var(--text-main); color:var(--bg)">v${ver}</span></td>
	                </tr>
	                <tr>
	                    <td>Hue Bridge IP</td>
	                    <td>${s.bridge_ip}</td>
	                </tr>
	                <tr>
	                    <td>Loxone IP</td>
	                    <td><input type="text" id="sys_loxIp" value="${s.loxone_ip || ''}"></td>
	                </tr>
	                <tr>
	                    <td>Loxone UDP Port</td>
	                    <td><input type="number" id="sys_loxPort" value="${s.loxone_port}"></td>
	                </tr>
	                <tr>
	                    <td>√úbergangszeit</td>
	                    <td>${rangeHtml}</td>
	                </tr>
	                <tr>
	                    <td>HTTP Port</td>
	                    <td>${s.http_port}</td>
	                </tr>
	                <tr>
	                    <td>Debug Modus</td>
	                    <td>${toggleHtml}</td>
	                </tr>
	                <tr>
	                    <td>App Key</td>
	                    <td>${s.key_configured ? '‚úÖ Konfiguriert' : '‚ùå Fehlt'}</td>
	                </tr>
	            `;
	        } catch(e) { 
	            console.error(e);
	            // Hier sehen wir jetzt den echten Fehler im UI!
	            document.getElementById('settingsTable').innerHTML = `<tr><td colspan="2" style="color:red">Fehler: ${e.message}</td></tr>`; 
	        }
	    }

    async function loadLogs() {
        try {
            const res = await fetch('/api/logs');
            const logs = await res.json();
            cachedLogs = logs; // Cache for filtering
            renderLogs();
        } catch(e) {}
    }

    // --- SCENES ---
    async function loadScenes() {
        const container = document.getElementById('scenesList');
        container.innerHTML = '<div class="text-center">Lade Szenen...</div>';

        try {
            const res = await fetch('/api/scenes');
            scenes = await res.json();
            renderScenes();
        } catch(e) {
            container.innerHTML = `<div style="color:red">Fehler beim Laden: ${e.message}</div>`;
        }
    }

    function xyToRgb(x, y, brightness = 100) {
        const z = 1.0 - x - y;
        const Y = brightness / 100;
        const X = (Y / y) * x;
        const Z = (Y / y) * z;

        let r = X * 1.656492 - Y * 0.354851 - Z * 0.255038;
        let g = -X * 0.707196 + Y * 1.655397 + Z * 0.036152;
        let b = X * 0.051713 - Y * 0.121364 + Z * 1.011530;

        r = Math.max(0, Math.min(1, r));
        g = Math.max(0, Math.min(1, g));
        b = Math.max(0, Math.min(1, b));

        return `rgb(${Math.round(r*255)}, ${Math.round(g*255)}, ${Math.round(b*255)})`;
    }

    async function activateSceneFromUI(uuid, sceneName) {
        try {
            const res = await fetch(`/scene/${uuid}/on`);
            const text = await res.text();

            if (res.ok) {
                activeScenes.add(uuid);
                renderScenes();
                console.log(`Scene "${sceneName}" activated`);
            } else {
                alert(`Fehler beim Aktivieren der Szene: ${text}`);
            }
        } catch(e) {
            alert(`Fehler: ${e.message}`);
        }
    }

    async function deactivateSceneFromUI(uuid, sceneName) {
        try {
            const res = await fetch(`/scene/${uuid}/off`);
            const text = await res.text();

            if (res.ok) {
                activeScenes.delete(uuid);
                renderScenes();
                console.log(`Scene "${sceneName}" deactivated`);
            } else {
                alert(`Fehler beim Deaktivieren der Szene: ${text}`);
            }
        } catch(e) {
            alert(`Fehler: ${e.message}`);
        }
    }

    function openSceneExportModal() {
        const list = document.getElementById('sceneExportList');
        list.innerHTML = '';

        if (scenes.length === 0) {
            return alert("Keine Szenen zum Exportieren.\nBitte zuerst Szenen laden.");
        }

        // Sort scenes alphabetically
        const sortedScenes = [...scenes].sort((a, b) => a.name.localeCompare(b.name));

        // Create checkbox items
        sortedScenes.forEach(scene => {
            const item = document.createElement('div');
            item.className = 'modal-item';

            // Build description line
            const groupName = scene.group ? scene.group.name : 'Keine Gruppe';
            const lightInfo = `${scene.lightCount} ${scene.lightCount === 1 ? 'Licht' : 'Lichter'}`;
            const description = `${groupName} ¬∑ ${lightInfo}`;

            item.innerHTML = `
                <input type="checkbox" class="modal-checkbox" value="${scene.uuid}">
                <div>
                    <div style="font-weight:bold">${scene.name}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">${description}</div>
                </div>
            `;

            list.appendChild(item);
        });

        document.getElementById('sceneExportModal').style.display = 'flex';
    }

    function toggleSelectAllScenes() {
        const checkboxes = document.querySelectorAll('#sceneExportList .modal-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);

        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });
    }

    function doSceneExport() {
        const checked = document.querySelectorAll('#sceneExportList .modal-checkbox:checked');

        if (checked.length === 0) {
            return alert("Bitte w√§hle mindestens eine Szene aus.");
        }

        // Collect selected scene UUIDs
        const uuids = Array.from(checked).map(cb => cb.value).join(',');

        // Download XML via API
        window.location.href = `/api/download/scenes?uuids=${uuids}`;

        // Close modal
        closeModal('sceneExportModal');
    }

    function renderScenes() {
        const container = document.getElementById('scenesList');

        if (scenes.length === 0) {
            container.innerHTML = '<div class="text-center text-muted-primary">Keine Szenen gefunden.</div>';
            return;
        }

        container.innerHTML = '';

        scenes.forEach(scene => {
            const div = document.createElement('div');
            div.className = 'mapping-item';
            div.style.borderLeftColor = '#9b59b6'; // Purple accent

            // Build light names list
            let lightsList = '';
            if (scene.lights && scene.lights.length > 0) {
                const lightNames = scene.lights.map(l => l.name).join(', ');
                lightsList = `<div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px">üí° ${lightNames}</div>`;
            }

            // Build palette and speed info line
            let extraInfo = '';
            let paletteHtml = '';
            let speedHtml = '';

            // Color palette preview
            if (scene.palette && scene.palette.color && scene.palette.color.length > 0) {
                const colors = scene.palette.color.slice(0, 5); // Max 5 colors
                const colorDots = colors.map(c => {
                    // Palette structure: c.color.xy.x and c.color.xy.y
                    if (c.color && c.color.xy) {
                        const rgb = xyToRgb(c.color.xy.x, c.color.xy.y, 100);
                        return `<span style="display:inline-block; width:10px; height:10px; border-radius:50%; background:${rgb}; margin-right:4px; border:1px solid var(--border)"></span>`;
                    }
                    return '';
                }).join('');
                paletteHtml = `üé® ${colorDots}`;
            }

            // Speed badge
            if (scene.speed !== null && scene.speed !== undefined) {
                const speedMs = Math.round(scene.speed * 1000);
                speedHtml = `‚ö° ${speedMs}ms`;
            }

            if (paletteHtml || speedHtml) {
                extraInfo = `<div style="font-size:0.8rem; color:var(--text-muted); margin-top:4px">${paletteHtml}${paletteHtml && speedHtml ? ' ' : ''}${speedHtml}</div>`;
            }

            // Group/Room badge
            let groupBadge = '';
            if (scene.group) {
                const icon = scene.group.type === 'room' ? 'üè†' : 'üìç';
                groupBadge = `<span class="badge" style="margin-right:8px">${icon} ${scene.group.name}</span>`;
            }

            // Light count badge
            const countBadge = `<span class="badge">${scene.lightCount} ${scene.lightCount === 1 ? 'Licht' : 'Lichter'}</span>`;

            // Check if scene is active
            const isActive = activeScenes.has(scene.uuid);

            // Active status badge
            const activeBadge = isActive ? '<span class="badge" style="background:var(--accent); color:white; margin-right:8px">‚úì Aktiv</span>' : '';

            // Change border color if active
            if (isActive) {
                div.style.borderLeftColor = 'var(--accent)';
                div.style.borderLeftWidth = '4px';
            }

            // Control buttons
            const buttons = `
                <div class="flex items-center gap-2 mt-2">
                    <button class="primary-btn btn-accent btn-compact"
                            onclick="activateSceneFromUI('${scene.uuid}', '${scene.name.replace(/'/g, "\\'")}')">
                        ‚ñ∂ Aktivieren
                    </button>
                    <button class="primary-btn btn-gray btn-compact"
                            onclick="deactivateSceneFromUI('${scene.uuid}', '${scene.name.replace(/'/g, "\\'")}')">
                        ‚èπ Aus
                    </button>
                </div>
            `;

            div.innerHTML = `
                <div>
                    <div class="mapping-lox" style="font-weight:700">${scene.name} <span style="font-size:0.75rem; color:var(--text-muted); font-weight:400">(${scene.uuid})</span></div>
                    ${lightsList}
                    ${extraInfo}
                    ${buttons}
                </div>
                <div class="status-badges">
                    ${activeBadge}
                    ${groupBadge}
                    ${countBadge}
                </div>
            `;

            container.appendChild(div);
        });
    }

    init();
</script>
</body>
</html>